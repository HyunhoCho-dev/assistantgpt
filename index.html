<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Assistant GPT - AI Agent powered by Groq</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for clean Light Mode */
        :root {
            --bg-light: #f7f7f7; /* Primary light background */
            --text-dark: #333333; /* Main text color */
            --bg-header: #ffffff; /* Header background */
            --bg-input: #ffffff; /* Input area background */
            --bg-user-message: #e9e9e9; /* Light gray for user background */
            --border-line: #dddddd; /* Separator lines */
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-light);
            color: var(--text-dark);
            margin: 0;
            padding: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: var(--bg-light);
        }
        ::-webkit-scrollbar-thumb {
            background: #aaaaaa;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #888888;
        }

        .chat-container {
            flex-grow: 1;
            overflow-y: auto;
            padding: 20px;
            max-width: 1000px;
            width: 100%;
            margin: 0 auto;
        }

        /* Chat display - Removing bubbles, using background for user only */
        .message-bubble {
            padding: 1rem 1.5rem;
            margin-bottom: 15px;
            border-radius: 0.5rem;
            max-width: 100%; /* Use full width for text flow */
            line-height: 1.6;
        }
        
        .ai-tool-call {
            background-color: #e0f2fe; /* Light blue for tool info */
            color: #0c4a6e;
            font-size: 0.85rem;
            border-left: 4px solid #38bdf8;
            padding: 0.75rem 1.5rem;
            margin: 0.5rem 0 1rem 0;
            border-radius: 0.5rem;
        }

        .user-message {
            background-color: var(--bg-user-message); /* Light gray background */
            color: var(--text-dark);
            margin-left: auto; /* Aligns to right */
            border-radius: 0.5rem; /* Soft corners */
        }

        .ai-message {
            background-color: transparent; /* No background */
            color: var(--text-dark);
            margin-right: auto; /* Aligns to left (default) */
            border-radius: 0; /* No corners */
        }

        .input-area {
            position: sticky;
            bottom: 0;
            background-color: var(--bg-input);
            border-top: 1px solid var(--border-line);
            padding: 20px 0;
            width: 100%;
            display: flex;
            justify-content: center;
            box-shadow: 0 -4px 6px -1px rgba(0, 0, 0, 0.05); /* Soft shadow for lift */
        }

        .input-wrapper {
            max-width: 1000px;
            width: 100%;
            padding: 0 20px;
        }

        /* Custom button style for submit */
        .submit-button {
            background-color: #3b82f6;
            color: white;
            transition: background-color 0.2s;
        }
        .submit-button:hover:not(:disabled) {
            background-color: #2563eb;
        }
        .submit-button:disabled {
            background-color: #ccc; /* Lighter disabled button */
            cursor: not-allowed;
            color: #666;
        }
        .pre-container {
            font-family: monospace;
            white-space: pre-wrap;
            word-break: break-all;
        }

        /* Styles for the custom toggle switch */
        .toggle-bg {
            background-color: #d1d5db; /* Gray-300 (OFF state) */
            position: relative;
        }
        .toggle-bg:before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #4f46e5; /* Indigo-600 (Active color) */
            border-radius: 9999px;
            opacity: 0;
            transition: opacity 0.3s;
        }
        #browserSearchToggle:checked ~ .toggle-bg {
            background-color: #4f46e5; /* Active color */
        }
        #browserSearchToggle:checked ~ .dot {
            transform: translateX(24px);
        }
        #browserSearchToggle:checked ~ .toggle-bg:before {
            opacity: 1;
        }
        
        /* Python Server Toggle Styles */
        #pythonServerToggle:checked ~ .toggle-bg {
            background-color: #4f46e5; /* Active color */
        }
        #pythonServerToggle:checked ~ .dot {
            transform: translateX(24px);
        }
        #pythonServerToggle:checked ~ .toggle-bg:before {
            opacity: 1;
        }
    </style>
</head>
<body>

    <!-- Header / Settings Area -->
    <header class="bg-white p-4 border-b border-gray-200 flex justify-between items-center sticky top-0 z-10" style="background-color: var(--bg-header);">
        <h1 class="text-xl font-bold text-gray-900">Assistant GPT (Code & Search Enabled)</h1>
        <button id="settingsBtn" class="p-2 rounded-full hover:bg-gray-100 transition duration-150">
            <!-- Settings Icon (Cog) -->
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-settings text-gray-600"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 0-.27 3.42l.51.25a2 2 0 0 1 1 1.74v.18a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.74l.51-.25a2 2 0 0 0-.27-3.42l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>
        </button>
    </header>

    <!-- Main Chat Area -->
    <main id="chatContainer" class="chat-container">
        <div class="text-center py-10">
            <h2 class="text-3xl font-semibold mb-2">Welcome to Assistant GPT</h2>
            <p class="text-lg text-gray-600">Your goal-oriented AI agent. Enter a complex task and watch it execute.</p>
            <p id="apiKeyStatus" class="mt-4 text-sm font-medium p-2 rounded-lg inline-block bg-red-200 text-red-800">
                âš ï¸ API Key Required. Click settings to enter your Groq API Key.
            </p>
            <p class="mt-2 text-sm text-gray-500">
                <span class="font-bold text-blue-600">GPT-OSS models now support Python Code Execution AND Browser Search</span>.
            </p>
        </div>
        <!-- Messages will be appended here -->
    </main>

    <!-- Input Area -->
    <div class="input-area">
        <div class="input-wrapper">
            <div class="flex items-end">
                <textarea
                    id="promptInput"
                    rows="1"
                    class="flex-grow p-4 bg-gray-100 text-gray-900 rounded-xl resize-none border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:outline-none placeholder-gray-500"
                    placeholder="ê³„ì‚°, ì½”ë”©, ë˜ëŠ” ìµœì‹  ì •ë³´ ê´€ë ¨ ì§ˆë¬¸ì„ ì…ë ¥í•´ ë³´ì„¸ìš”. (ì˜ˆ: ì˜¤ëŠ˜ AI ë¶„ì•¼ ìµœì‹  ë‰´ìŠ¤ëŠ”?)"
                    style="max-height: 200px; transition: height 0.2s;"
                ></textarea>
                <button
                    id="submitBtn"
                    class="submit-button ml-4 p-3 rounded-xl h-12 w-12 flex items-center justify-center disabled:opacity-50"
                    disabled
                >
                    <!-- Send Icon -->
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-send"><path d="m22 2-7 20-4-9-9-4 20-7z"/></svg>
                </button>
            </div>
            <p class="text-xs text-center text-gray-500 mt-2">Assistant GPT will use Python code for complex calculations, and Browser Search for real-time information.</p>
        </div>
    </div>

    <!-- API Key/Settings Modal -->
    <div id="settingsModal" class="fixed inset-0 bg-black bg-opacity-75 hidden items-center justify-center z-20">
        <div class="bg-white p-8 rounded-lg shadow-2xl max-w-md w-full border border-gray-300">
            <h3 class="text-2xl font-bold mb-6 text-gray-900">Agent Settings</h3>

            <div class="mb-4">
                <label for="apiKeyInput" class="block text-sm font-medium text-gray-700 mb-2">Groq API Key</label>
                <input type="password" id="apiKeyInput" class="w-full p-3 rounded-lg bg-gray-100 text-gray-900 border border-gray-300 focus:ring-blue-500 focus:border-blue-500" placeholder="Enter your Groq API Key (starts with 'gsk_...')">
                <p class="text-xs text-blue-600 mt-1">Key is now saved in your browser (Local Storage) and will persist across reloads.</p>
            </div>

            <div class="mb-6">
                <label for="modelSelect" class="block text-sm font-medium text-gray-700 mb-2">Select Model</label>
                <select id="modelSelect" class="w-full p-3 rounded-lg bg-gray-100 text-gray-900 border border-gray-300 focus:ring-blue-500 focus:border-blue-500">
                    <!-- Updated Model names to reflect dual capability -->
                    <option value="openai/gpt-oss-20b" selected>GPT-OSS 20B (Code & Search)</option>
                    <option value="openai/gpt-oss-120b">GPT-OSS 120B (Code & Search)</option>
                    <option value="groq/compound">Groq Compound (Native Web Search)</option>
                    <option value="groq/compound-mini">Groq Compound Mini (Native Web Search)</option>
                </select>
                <p class="text-xs text-gray-500 mt-1">
                    *GPT-OSS: Code + Browser Search | *Compound: Native Web Search (faster, automatic)
                </p>
            </div>

            <!-- â—ï¸ Browser Search Toggle â—ï¸ -->
            <div class="mb-6">
                <label for="browserSearchToggle" class="flex items-center cursor-pointer">
                    <div class="relative">
                        <input type="checkbox" id="browserSearchToggle" class="sr-only">
                        <div class="block w-14 h-8 rounded-full transition duration-300 ease-in-out toggle-bg"></div>
                        <div class="dot absolute left-1 top-1 bg-white w-6 h-6 rounded-full transition duration-300 ease-in-out"></div>
                    </div>
                    <div class="ml-3 text-sm font-medium text-gray-700">
                        ì‹¤ì‹œê°„ ì›¹ ê²€ìƒ‰ ì‚¬ìš© (Browser Search)
                    </div>
                </label>
                <p class="text-xs text-gray-500 mt-1">
                    **ONì´ë©´, ìµœì‹  ì •ë³´ê°€ í•„ìš”í•œ ì§ˆë¬¸ì— ë¬´ì¡°ê±´ íˆ´ì„ ì‚¬ìš©í•˜ë„ë¡ ëª¨ë¸ì— ì§€ì‹œí•©ë‹ˆë‹¤.**
                </p>
            </div>
            <!-- â—ï¸ Browser Search Toggle ë â—ï¸ -->

            <!-- â—ï¸ Python Server Toggle â—ï¸ -->
            <div class="mb-6">
                <label for="pythonServerToggle" class="flex items-center cursor-pointer">
                    <div class="relative">
                        <input type="checkbox" id="pythonServerToggle" class="sr-only">
                        <div class="block w-14 h-8 rounded-full transition duration-300 ease-in-out toggle-bg"></div>
                        <div class="dot absolute left-1 top-1 bg-white w-6 h-6 rounded-full transition duration-300 ease-in-out"></div>
                    </div>
                    <div class="ml-3 text-sm font-medium text-gray-700">
                        Python ì„œë²„ ë¸Œë¼ìš°ì € ìë™í™” ì‚¬ìš©
                    </div>
                </label>
                <p class="text-xs text-gray-500 mt-1">
                    **ONì´ë©´ Python Playwright ì„œë²„ë¡œ ì‹¤ì œ ë¸Œë¼ìš°ì €ë¥¼ ì œì–´í•©ë‹ˆë‹¤. (í˜„ì¬ ë„ë©”ì¸ ìë™ ê°ì§€)**
                </p>
            </div>
            <!-- â—ï¸ Python Server Toggle ë â—ï¸ -->
                <button id="closeModalBtn" class="px-6 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition duration-150">
                    Save and Close
                </button>
            </div>
        </div>
    </div>

    <script>
        // Global variables for API Key, UI State, and Chat History
        let GROQ_API_KEY = null;
        let isProcessing = false;
        let isBrowserSearchEnabled = true;
        let usePythonServer = false;  // Python ì„œë²„ ì‚¬ìš© ì—¬ë¶€
        // ë§¥ë½ ìœ ì§€ë¥¼ ìœ„í•´ ëŒ€í™” ê¸°ë¡ì„ ì €ì¥í•˜ëŠ” ë°°ì—´ì…ë‹ˆë‹¤.
        const chatHistory = []; 
        
        // íˆ´ ì‚¬ìš© ê°€ëŠ¥í•œ ëª¨ë¸ ëª©ë¡ (Code Interpreter ë° Browser Search)
        const multiToolCapableModels = [ 
            'openai/gpt-oss-120b', 
            'openai/gpt-oss-20b',
            'groq/compound',
            'groq/compound-mini'
        ];


        // --- Utility Functions ---

        /**
         * Load settings from localStorage
         */
        function loadSettings() {
            const storedKey = localStorage.getItem('groqApiKey');
            const storedModel = localStorage.getItem('groqSelectedModel');
            const storedSearchEnabled = localStorage.getItem('isBrowserSearchEnabled');
            const storedPythonEnabled = localStorage.getItem('usePythonServer');

            if (storedKey) {
                GROQ_API_KEY = storedKey;
            }

            // Set default model
            if (storedModel && multiToolCapableModels.includes(storedModel)) {
                modelSelect.value = storedModel;
            } else {
                modelSelect.value = 'openai/gpt-oss-20b'; 
            }

            // ê²€ìƒ‰ íˆ´ ìƒíƒœ ì ìš©
            if (storedSearchEnabled !== null) {
                isBrowserSearchEnabled = storedSearchEnabled === 'true';
            }
            
            // Python ì„œë²„ ìƒíƒœ ì ìš©
            if (storedPythonEnabled !== null) {
                usePythonServer = storedPythonEnabled === 'true';
            }
        }

        /**
         * Save settings to localStorage
         */
        function saveSettings(key, model, isSearchEnabled, isPythonEnabled) { 
            localStorage.setItem('groqApiKey', key);
            localStorage.setItem('groqSelectedModel', model);
            localStorage.setItem('isBrowserSearchEnabled', isSearchEnabled);
            localStorage.setItem('usePythonServer', isPythonEnabled);
        }

        /**
         * Exponential Backoff Retry mechanism for fetch.
         * Retries the fetch request if it fails, with increasing delay.
         */
        async function fetchWithRetry(url, options, maxRetries = 3) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.status === 429 && i < maxRetries - 1) {
                        const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                        console.warn(`Rate limit hit (429). Retrying in ${delay / 1000}s...`);
                        await new Promise(resolve => setTimeout(resolve, delay));
                        continue;
                    }
                    if (!response.ok) {
                        const errorData = await response.json();
                        const errorMessage = errorData.error?.message || response.statusText;
                        // 400 ì—ëŸ¬ ë©”ì‹œì§€ì—ì„œ íŠ¹ì • í‚¤ì›Œë“œë¥¼ ì°¾ì•„ ë¡œê·¸ì— ìƒì„¸ ì •ë³´ ì¶”ê°€
                        if (errorMessage.includes('executed_tools')) {
                            console.error(`CRITICAL ERROR (400 - executed_tools): This error means the 'executed_tools' property was not successfully stripped from the assistant message history before sending. Check 'cleanMessageForAPI' function.`, errorMessage);
                        } else if (errorMessage.includes('Tool choice is none')) {
                            console.error(`API Error (400 - Tool Choice): The model called a tool, but the tool_choice setting was likely set to 'none' or the tool definition was malformed.`, errorMessage);
                        }
                        throw new Error(`API Error: ${response.status} - ${errorMessage}`);
                    }
                    return response;
                } catch (error) {
                    if (i === maxRetries - 1) {
                        console.error("Max retries reached. Request failed.", error);
                        throw error;
                    }
                    const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }


        // --- UI & State Management ---

        const chatContainer = document.getElementById('chatContainer');
        const promptInput = document.getElementById('promptInput');
        const submitBtn = document.getElementById('submitBtn');
        const settingsBtn = document.getElementById('settingsBtn');
        const settingsModal = document.getElementById('settingsModal');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const apiKeyInput = document.getElementById('apiKeyInput');
        const modelSelect = document.getElementById('modelSelect');
        const apiKeyStatus = document.getElementById('apiKeyStatus');
        const browserSearchToggle = document.getElementById('browserSearchToggle');
        const pythonServerToggle = document.getElementById('pythonServerToggle'); 

        function updateUIState() {
            const isKeyValid = GROQ_API_KEY && GROQ_API_KEY.startsWith('gsk_');
            const isInputEmpty = promptInput.value.trim() === '';
            const selectedModel = modelSelect.value;
            const isToolCapable = multiToolCapableModels.includes(selectedModel);


            // Update submit button state
            submitBtn.disabled = isProcessing || !isKeyValid || isInputEmpty;

            // Update API Key Status Text
            if (isKeyValid) {
                apiKeyStatus.classList.remove('bg-red-200', 'text-red-800');
                apiKeyStatus.classList.add('bg-green-200', 'text-green-800');
                
                let toolStatus = 'Code Execution';
                if (isBrowserSearchEnabled) {
                    toolStatus += ' AND Browser Search (ON)';
                } else {
                    toolStatus += ' (Browser Search OFF)';
                }

                if (isToolCapable) {
                    apiKeyStatus.innerHTML = `âœ… Ready with Model: **${selectedModel}** (${toolStatus})`;
                } else {
                    apiKeyStatus.innerHTML = `âœ… Ready with Model: **${selectedModel}** (Text Only)`;
                }
            } else {
                apiKeyStatus.classList.remove('bg-green-200', 'text-green-800');
                apiKeyStatus.classList.add('bg-red-200', 'text-red-800');
                apiKeyStatus.innerHTML = 'âš ï¸ API Key Required. Click settings to enter your Groq API Key.';
            }

            // Scroll to bottom
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // Auto-resize textarea logic
        function autoResizeTextarea() {
            promptInput.style.height = 'auto';
            promptInput.style.height = promptInput.scrollHeight + 'px';
        }

        // --- Message Display ---

        function appendMessage(role, content) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message-bubble');

            if (role === 'user') {
                messageDiv.classList.add('user-message', 'ml-auto');
                messageDiv.textContent = content;
            } else { // assistant
                messageDiv.classList.add('ai-message', 'mr-auto');
                messageDiv.innerHTML = content; 
            }

            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            return messageDiv;
        }
        
        function formatAgentResponse(text) {
             // Simple markdown-like formatting for display
            text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>'); 
            text = text.replace(/\n\n/g, '<br><br>');
            text = text.replace(/\n/g, '<br>');
            return text;
        }

        /**
         * Safely parses tool arguments which might be a JSON string or already an object.
         */
        function getParsedArgs(args) {
            // If args is already an object, return it.
            if (typeof args === 'object' && args !== null) {
                return args;
            }
            // If args is a string, attempt to parse it as JSON.
            if (typeof args === 'string' && args.trim().startsWith('{')) {
                try {
                    return JSON.parse(args);
                } catch (e) {
                    // If parsing fails, return an object containing the raw string for inspection
                    return { raw_string: args }; 
                }
            }
            // Return the argument itself if it's a primitive type that's not JSON
            return args; 
        }

        /**
         * Formats the tool execution result, distinguishing between Code and Search.
         * @param {object} tool - The tool execution object from the Groq API response.
         */
        function formatExecutedTool(tool) {
            
            const parsedArgs = getParsedArgs(tool.arguments);

            let toolTitle, inputLabel, inputContent;
            
            // Groq's API uses 'output' for browser_search and 'code_results' for code_interpreter
            const toolOutput = tool.output || tool.code_results?.[0]?.text || 'No output captured.';

            // Identify tool type based on function name (most reliable)
            if (tool.name === 'browser_search') {
                toolTitle = 'ğŸ” ì›¹ ê²€ìƒ‰ (Browser Search)';
                inputLabel = 'ê²€ìƒ‰ ì¿¼ë¦¬:';
                // Display parsed arguments (should be a JSON object like {query: '...'})
                inputContent = parsedArgs; 
            } 
            else if (tool.name === 'code_interpreter') {
                toolTitle = 'ğŸ› ï¸ ì½”ë“œ ì‹¤í–‰ (Python Interpreter)';
                inputLabel = 'ì‹¤í–‰ ì½”ë“œ:';
                // Extract only the code string from the arguments object
                inputContent = parsedArgs && typeof parsedArgs === 'object' && 'code' in parsedArgs ? parsedArgs.code : parsedArgs; 
            } 
            else {
                toolTitle = 'ğŸ”§ íˆ´ ì‹¤í–‰ (ì•Œ ìˆ˜ ì—†ìŒ)';
                inputLabel = 'ì…ë ¥:';
                inputContent = tool.arguments || 'N/A';
            }
            

            // Format inputContent for display
            let formattedInput;
            if (typeof inputContent === 'object' && inputContent !== null) {
                // If it's an object, stringify it nicely
                formattedInput = JSON.stringify(inputContent, null, 2);
            } else {
                // If it's a string (e.g., Python code) or primitive, display it directly
                formattedInput = String(inputContent);
            }
            
            // HTML escape the input and output to prevent injection and display code correctly
            formattedInput = formattedInput.replace(/</g, '&lt;').replace(/>/g, '&gt;');
            const formattedOutput = toolOutput.replace(/</g, '&lt;').replace(/>/g, '&gt;');

            let html = `<div class="ai-tool-call">`;
            html += `<strong>${toolTitle}</strong><br>`;
            html += `<strong class="text-xs text-gray-700">${inputLabel}</strong> <div class="pre-container p-2 mt-1 mb-2 rounded bg-gray-50 border border-gray-300 text-gray-800 overflow-x-auto text-sm">${formattedInput}</div>`;
            html += `<strong class="text-xs text-gray-700">íˆ´ ì¶œë ¥:</strong> <div class="pre-container p-2 mt-1 rounded bg-gray-50 border border-gray-300 text-gray-800 overflow-x-auto text-sm">${formattedOutput}</div>`;
            html += `</div>`;
            return html;
        }

        /**
         * Cleans assistant messages for API submission by removing unsupported fields like executed_tools, tool_calls, and reasoning.
         * @param {object} message - The message object from chatHistory.
         * @returns {object} A cleaned message object ready for the Groq API payload.
         */
        function cleanMessageForAPI(message) {
            // Groq APIì— ë³´ë‚¼ ë•ŒëŠ” ë¶ˆí•„ìš”í•œ í•„ë“œë¥¼ ì œê±°í•´ì•¼ í•©ë‹ˆë‹¤.
            if (message.role === 'assistant') {
                // êµ¬ì¡° ë¶„í•´ í• ë‹¹ì„ ì‚¬ìš©í•˜ì—¬ ë¶ˆí•„ìš”í•œ í•„ë“œë¥¼ ì œì™¸í•˜ê³  ë‚˜ë¨¸ì§€ ì†ì„±ì„ ë³µì‚¬í•©ë‹ˆë‹¤.
                const { executed_tools, tool_calls, reasoning, ...cleanedMessage } = message;
                return cleanedMessage;
            }
            return message;
        }


        // --- Core Agent Logic (Groq API Call) ---

        async function processGoal() {
            if (isProcessing) return;

            const userGoal = promptInput.value.trim();
            if (!userGoal || !GROQ_API_KEY) {
                updateUIState();
                return;
            }

            // 1. Setup UI for processing
            isProcessing = true;
            submitBtn.disabled = true;
            
            // ì‚¬ìš©ì ë©”ì‹œì§€ UI í‘œì‹œ
            appendMessage('user', userGoal);
            
            // ì‚¬ìš©ì ë©”ì‹œì§€ë¥¼ chatHistoryì— ì¶”ê°€ (ë§¥ë½ ìœ ì§€)
            chatHistory.push({ role: "user", content: userGoal });

            promptInput.value = '';
            autoResizeTextarea();
            updateUIState();

            // Create a loading/placeholder message for the AI response
            const loadingMessage = appendMessage('assistant', '...');
            loadingMessage.innerHTML = 'Thinking... <span class="animate-spin text-lg">ğŸ§ </span>';

            // Python ì„œë²„ê°€ í™œì„±í™”ë˜ì–´ ìˆìœ¼ë©´ ë¨¼ì € ì‹œë„
            if (usePythonServer) {
                await processPythonServer(userGoal, loadingMessage);
            } else {
                await processGroqAPI(userGoal, loadingMessage);
            }
            
            // 5. Final UI Cleanup
            isProcessing = false;
            updateUIState();
        }
        
        /**
         * Python ì„œë²„ë¡œ ë¸Œë¼ìš°ì € ìë™í™” ìš”ì²­ - AIê°€ ìƒì„±í•œ Playwright ì½”ë“œ ì‹¤í–‰
         */
        async function processPythonServer(userGoal, loadingMessage) {
            try {
                console.log("Python ì„œë²„ë¡œ AI ê¸°ë°˜ ë¸Œë¼ìš°ì € ìë™í™” ì‹œì‘:", userGoal);
                
                // URL ì¶”ì¶œ
                const urlMatch = userGoal.match(/https?:\/\/[^\s]+/);
                let analysisResult = null;
                
                // 1ë‹¨ê³„: URLì´ ìˆìœ¼ë©´ ë¨¼ì € í˜ì´ì§€ ë¶„ì„
                if (urlMatch) {
                    const targetUrl = urlMatch[0];
                    console.log("1ë‹¨ê³„: í˜ì´ì§€ ë¶„ì„ ì‹œì‘ -", targetUrl);
                    loadingMessage.innerHTML = 'ğŸ” í˜ì´ì§€ êµ¬ì¡° ë¶„ì„ ì¤‘... (1/3)';
                    
                    try {
                        const analyzeUrl = `${window.location.origin}/api/analyze`;
                        const analyzeResponse = await fetch(analyzeUrl, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ url: targetUrl })
                        });
                        
                        analysisResult = await analyzeResponse.json();
                        console.log("í˜ì´ì§€ ë¶„ì„ ê²°ê³¼:", analysisResult);
                        
                        if (analysisResult.success) {
                            loadingMessage.innerHTML = `âœ… í˜ì´ì§€ ë¶„ì„ ì™„ë£Œ! (1/3)<br>
                            ğŸ“„ ì œëª©: ${analysisResult.title}<br>
                            ğŸ”˜ ë²„íŠ¼: ${analysisResult.elements.buttons.length}ê°œ<br>
                            ğŸ“ ì…ë ¥í•„ë“œ: ${analysisResult.elements.inputs.length}ê°œ<br>
                            ğŸ”— ë§í¬: ${analysisResult.elements.links.length}ê°œ`;
                        }
                    } catch (analyzeError) {
                        console.warn("í˜ì´ì§€ ë¶„ì„ ì‹¤íŒ¨, ë¶„ì„ ì—†ì´ ì§„í–‰:", analyzeError);
                    }
                }
                
                // 2ë‹¨ê³„: AIê°€ Playwright ì½”ë“œ ìƒì„± (ë¶„ì„ ê²°ê³¼ í¬í•¨)
                console.log("2ë‹¨ê³„: Playwright ì½”ë“œ ìƒì„±");
                loadingMessage.innerHTML = 'ğŸ¤– Playwright ì œì–´ ì½”ë“œ ìƒì„± ì¤‘... (2/3)';
                
                const selectedModel = modelSelect.value;
                
                // ë¶„ì„ ê²°ê³¼ê°€ ìˆìœ¼ë©´ AIì—ê²Œ ì œê³µ
                let systemInstruction = `ë‹¹ì‹ ì€ Playwright Pythonì„ ì „ë¬¸ìœ¼ë¡œ í•˜ëŠ” ì›¹ ìë™í™” ì „ë¬¸ê°€ì…ë‹ˆë‹¤. 
ì‚¬ìš©ìì˜ ìš”ì²­ì„ ë°›ìœ¼ë©´ Playwrightë¥¼ ì‚¬ìš©í•˜ì—¬ ì›¹ì‚¬ì´íŠ¸ë¥¼ ì œì–´í•˜ëŠ” Python ì½”ë“œë¥¼ ì‘ì„±í•˜ì„¸ìš”.

ì¤‘ìš”í•œ ê·œì¹™:
1. ì½”ë“œëŠ” page ê°ì²´ê°€ ì´ë¯¸ ìƒì„±ë˜ì–´ ìˆë‹¤ê³  ê°€ì •í•˜ì„¸ìš”. (page = browser.new_page())
2. page.goto(), page.fill(), page.click(), page.wait_for_timeout(), page.wait_for_selector() ë“±ì„ ì‚¬ìš©í•˜ì„¸ìš”.
3. ì ˆëŒ€ë¡œ browser = ë‚˜ page = ë¥¼ ë‹¤ì‹œ ì •ì˜í•˜ì§€ ë§ˆì„¸ìš”.
4. ì½”ë“œë§Œ ì‘ì„±í•˜ê³  ì„¤ëª…ì€ í•˜ì§€ ë§ˆì„¸ìš”.
5. \`\`\`python ë§ˆí¬ë‹¤ìš´ í¬ë§·ì„ ì‚¬ìš©í•˜ì—¬ ì½”ë“œë¥¼ ê°ì‹¸ì„¸ìš”.
6. í•­ìƒ page.wait_for_load_state("networkidle")ë¥¼ ì‚¬ìš©í•˜ì—¬ í˜ì´ì§€ ë¡œë”©ì„ ê¸°ë‹¤ë¦¬ì„¸ìš”.
7. ë™ì  ì½˜í…ì¸ ê°€ ìˆì„ ê²½ìš° page.wait_for_timeout(2000-3000)ì„ ì¶”ê°€í•˜ì„¸ìš”.`;

                let userPrompt = userGoal;
                
                // ë¶„ì„ ê²°ê³¼ê°€ ìˆìœ¼ë©´ AIì—ê²Œ ìƒì„¸ ì •ë³´ ì œê³µ
                if (analysisResult && analysisResult.success) {
                    systemInstruction += `\n\nğŸ” í˜ì´ì§€ ë¶„ì„ ê²°ê³¼:\nì œëª©: ${analysisResult.title}\nURL: ${analysisResult.url}\n\nì‚¬ìš© ê°€ëŠ¥í•œ ìš”ì†Œ:\n`;
                    
                    // ë²„íŠ¼ ì •ë³´
                    if (analysisResult.elements.buttons.length > 0) {
                        systemInstruction += "\në²„íŠ¼:\n";
                        analysisResult.elements.buttons.slice(0, 5).forEach((btn, i) => {
                            systemInstruction += `  ${i+1}. í…ìŠ¤íŠ¸: "${btn.text}", ID: "${btn.id}", Class: "${btn.class}"\n`;
                        });
                    }
                    
                    // ì…ë ¥ í•„ë“œ ì •ë³´
                    if (analysisResult.elements.inputs.length > 0) {
                        systemInstruction += "\nì…ë ¥ í•„ë“œ:\n";
                        analysisResult.elements.inputs.slice(0, 5).forEach((input, i) => {
                            systemInstruction += `  ${i+1}. Type: "${input.type}", Name: "${input.name}", ID: "${input.id}", Placeholder: "${input.placeholder}"\n`;
                        });
                    }
                    
                    // ë§í¬ ì •ë³´
                    if (analysisResult.elements.links.length > 0) {
                        systemInstruction += "\në§í¬:\n";
                        analysisResult.elements.links.slice(0, 5).forEach((link, i) => {
                            systemInstruction += `  ${i+1}. í…ìŠ¤íŠ¸: "${link.text}", Href: "${link.href}", ID: "${link.id}"\n`;
                        });
                    }
                    
                    systemInstruction += `\nìœ„ ë¶„ì„ ê²°ê³¼ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì •í™•í•œ ì…€ë ‰í„°ë¥¼ ì‚¬ìš©í•˜ì—¬ ì½”ë“œë¥¼ ì‘ì„±í•˜ì„¸ìš”.\nì˜ˆ: IDê°€ ìˆìœ¼ë©´ #id, Classê°€ ìˆìœ¼ë©´ .class, ì—†ìœ¼ë©´ í…ìŠ¤íŠ¸ë¡œ ì„ íƒí•˜ì„¸ìš”.`;
                }
                
                systemInstruction += `\n\nì˜ˆì‹œ:\n\`\`\`python\npage.goto('https://example.com')\npage.wait_for_load_state("networkidle")\npage.wait_for_timeout(2000)\n\n# ë²„íŠ¼ í´ë¦­ (ID ì‚¬ìš©)\npage.wait_for_selector('#play-btn')\npage.click('#play-btn')\n\n# ì…ë ¥ í•„ë“œ ì±„ìš°ê¸°\npage.fill('input[name="search"]', 'hello')\npage.press('input[name="search"]', 'Enter')\npage.wait_for_timeout(3000)\n\`\`\``;
                
                const messages = [
                    { role: "system", content: systemInstruction },
                    { role: "user", content: userPrompt }
                ];
                
                const payload = {
                    model: selectedModel,
                    messages: messages,
                    temperature: 0.5,
                    max_tokens: 2048
                };
                
                const options = {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${GROQ_API_KEY}`
                    },
                    body: JSON.stringify(payload)
                };
                
                const apiUrl = 'https://api.groq.com/openai/v1/chat/completions';
                const response = await fetchWithRetry(apiUrl, options);
                const data = await response.json();
                
                console.log("AI ì½”ë“œ ìƒì„± ì‘ë‹µ:", data);
                
                if (!data.choices || data.choices.length === 0) {
                    throw new Error("AI ì½”ë“œ ìƒì„± ì‹¤íŒ¨");
                }
                
                let generatedCode = data.choices[0].message.content || '';
                
                // ë§ˆí¬ë‹¤ìš´ í˜•ì‹ì˜ ì½”ë“œ ë¸”ë¡ ì¶”ì¶œ
                const codeMatch = generatedCode.match(/\`\`\`python\n([\s\S]*?)\`\`\`/);
                if (codeMatch) {
                    generatedCode = codeMatch[1].trim();
                }
                
                console.log("ìƒì„±ëœ Playwright ì½”ë“œ:", generatedCode);
                
                if (!generatedCode.trim()) {
                    throw new Error("AIê°€ ìœ íš¨í•œ ì½”ë“œë¥¼ ìƒì„±í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
                }
                
                // 3ë‹¨ê³„: ìƒì„±ëœ ì½”ë“œ ì‹¤í–‰
                console.log("3ë‹¨ê³„: Playwright ì½”ë“œ ì‹¤í–‰");
                loadingMessage.innerHTML = 'ğŸŒ Playwright ì½”ë“œ ì‹¤í–‰ ì¤‘... (3/3)';
                
                const serverUrl = `${window.location.origin}/api/browse`;
                const executeResponse = await fetch(serverUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        goal: userGoal,
                        code: generatedCode
                    })
                });
                
                const executeData = await executeResponse.json();
                console.log("Python ì„œë²„ ì‘ë‹µ:", executeData);
                
                if (executeData.success) {
                    // ë¸Œë¼ìš°ì € ìë™í™” ì‘ì—… ì™„ë£Œ
                    let resultHTML = `<div class="ai-tool-call"><strong>ğŸ¯ ë¸Œë¼ìš°ì € ìë™í™” ì™„ë£Œ</strong><br>`;
                    
                    // ë¶„ì„ ê²°ê³¼ í‘œì‹œ
                    if (analysisResult && analysisResult.success) {
                        resultHTML += `<strong>ğŸ“Š ë¶„ì„ ê²°ê³¼:</strong><br>`;
                        resultHTML += `- í˜ì´ì§€: ${analysisResult.title}<br>`;
                        resultHTML += `- ë²„íŠ¼: ${analysisResult.elements.buttons.length}ê°œ, `;
                        resultHTML += `ì…ë ¥í•„ë“œ: ${analysisResult.elements.inputs.length}ê°œ, `;
                        resultHTML += `ë§í¬: ${analysisResult.elements.links.length}ê°œ<br><br>`;
                    }
                    
                    resultHTML += `<strong>âœ… ì‹¤í–‰ ê²°ê³¼:</strong><br>`;
                    resultHTML += `${executeData.result}<br>`;
                    resultHTML += `ğŸ“ URL: <a href="${executeData.url}" target="_blank" style="color: #3b82f6; text-decoration: underline;">${executeData.url}</a><br><br>`;
                    resultHTML += `<strong>ğŸ“ ìƒì„±ëœ ì½”ë“œ:</strong><div class="pre-container p-2 mt-1 rounded bg-gray-50 border border-gray-300 text-gray-800 overflow-x-auto text-sm">${generatedCode.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</div><br>`;
                    resultHTML += `</div>`;
                    
                    loadingMessage.innerHTML = resultHTML + formatAgentResponse('ğŸ‰ ë¸Œë¼ìš°ì € ìë™í™” ì‘ì—…ì´ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!');
                    chatHistory.push({ role: "assistant", content: `ë¸Œë¼ìš°ì € ìë™í™” ì™„ë£Œ: ${executeData.result}\n\nìƒì„±ëœ ì½”ë“œ:\n\`\`\`python\n${generatedCode}\n\`\`\`` });
                } else {
                    loadingMessage.innerHTML = formatAgentResponse(`âš ï¸ ì‘ì—… ì‹¤íŒ¨: ${executeData.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}`);
                    chatHistory.push({ role: "assistant", content: `ë¸Œë¼ìš°ì € ìë™í™” ì‹¤íŒ¨: ${executeData.error}` });
                }
            } catch (error) {
                console.error("Python ì„œë²„ ë˜ëŠ” AI ì½”ë“œ ìƒì„± ì˜¤ë¥˜:", error);
                loadingMessage.innerHTML = formatAgentResponse(`âš ï¸ ì˜¤ë¥˜: ${error.message}<br>ì„œë²„ê°€ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸í•´ ì£¼ì„¸ìš”.`);
                chatHistory.push({ role: "assistant", content: `ì˜¤ë¥˜: ${error.message}` });
            }
        }

        
        }
        
        /**
         * Groq API ì²˜ë¦¬ (ê¸°ì¡´ ë¡œì§)
         */
        async function processGroqAPI(userGoal, loadingMessage) {
            const selectedModel = modelSelect.value;

            
            // --- íˆ´ ì •ì˜ ë° ì‹œìŠ¤í…œ ëª…ë ¹ì–´ ì¡°ê±´ë¶€ ì„¤ì • ---
            let systemInstruction = `You are Assistant GPT, a powerful, ultra-fast, and helpful AI. Respond concisely and clearly in Korean. Use the Python Code Interpreter tool only when calculation or code execution is explicitly required to answer the user's question. Maintain the conversation context from the chat history provided.`;
            
            // Base tools (í•­ìƒ ì½”ë“œ ì¸í„°í”„ë¦¬í„°ë¥¼ í¬í•¨)
            const baseTools = [
                {
                    type: "function",
                    function: {
                        name: "code_interpreter",
                        description: "Execute Python code to solve complex calculations, data analysis, or numerical tasks. The code output will be returned to the model as context.",
                        parameters: {
                            type: "object",
                            properties: {
                                code: {
                                    type: "string",
                                    description: "The Python code to execute. Print output using the print() function."
                                }
                            },
                            required: ["code"]
                        }
                    }
                }
            ];

            let agentTools = [...baseTools]; 
            let isCompoundModel = selectedModel.startsWith('groq/compound');
            
            // Compound ëª¨ë¸ì´ ì•„ë‹Œ ê²½ìš°ì—ë§Œ Browser Search ë„êµ¬ ì¶”ê°€
            if (isBrowserSearchEnabled && !isCompoundModel) {
                const browserSearchTool = {
                    type: "function",
                    function: {
                        name: "browser_search",
                        description: "Performs a real-time web search for up-to-date or external information (e.g., news, current events, game information).",
                        parameters: {
                            type: "object",
                            properties: {
                                query: {
                                    type: "string",
                                    description: "The search query."
                                }
                            },
                            required: ["query"]
                        }
                    }
                };
                agentTools.push(browserSearchTool);
                
                // í™œì„±í™” ì‹œ íˆ´ ì‚¬ìš© ê°•ì œ (ì‚¬ìš©ì ìš”ì²­ ì‚¬í•­)
                systemInstruction = `You are Assistant GPT, a powerful, ultra-fast, and helpful AI. Respond concisely and clearly in Korean. Use the Python Code Interpreter tool only when calculation or code execution is explicitly required to answer the user's question. **CRITICAL: For any question requiring up-to-date or external information (like current events, weather, news, stock prices), you MUST use the browser_search tool.** Maintain the conversation context from the chat history provided.`;
            } else if (isCompoundModel) {
                // Compound ëª¨ë¸ì€ ê¸°ë³¸ì ìœ¼ë¡œ ì›¹ ê²€ìƒ‰ ì§€ì›
                systemInstruction = `You are Assistant GPT, a powerful, ultra-fast, and helpful AI. Respond concisely and clearly in Korean. Use web search automatically for any questions requiring up-to-date or external information. Maintain the conversation context from the chat history provided.`;
            }


            // APIì— ì „ë‹¬í•  ìµœì¢… ë©”ì‹œì§€ ë¦¬ìŠ¤íŠ¸
            // â—ï¸ ì˜¤ë¥˜ 1 í•´ê²°: chatHistoryì˜ assistant ë©”ì‹œì§€ì—ì„œ executed_toolsë¥¼ ì œê±°í•œ í›„ ì „ì†¡í•©ë‹ˆë‹¤.
            const messagesToSend = [
                { role: "system", content: systemInstruction },
                ...chatHistory
                    .filter(msg => msg.role !== 'system')
                    .map(cleanMessageForAPI) 
            ];
            
            const payload = {
                model: selectedModel,
                messages: messagesToSend, 
                temperature: 0.5,
                max_tokens: 4096
            };
            
            // Compound ëª¨ë¸ì´ ì•„ë‹Œ ê²½ìš°ì—ë§Œ tools ì¶”ê°€
            if (!isCompoundModel) {
                payload.tools = agentTools;
                payload.tool_choice = "auto";
            }
            
            const options = {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${GROQ_API_KEY}`
                },
                body: JSON.stringify(payload)
            };

            try {
                // 3. API Call with Retry Logic
                const response = await fetchWithRetry(apiUrl, options);
                const data = await response.json();

                // 4. Process Response
                console.log("API Response:", data); // ë””ë²„ê¹…: ì „ì²´ ì‘ë‹µ ë¡œê¹…
                
                if (data.choices && data.choices.length > 0) {
                    const choice = data.choices[0];
                    const agentMessage = choice.message;
                    console.log("Agent Message:", agentMessage); // ë””ë²„ê¹…: ì—ì´ì „íŠ¸ ë©”ì‹œì§€ ë¡œê¹…
                    
                    let agentResponse = agentMessage.content || '';
                    let toolOutput = '';

                    // Check for executed tools (Code Interpreter, Browser Search, Web Search results)
                    if (agentMessage.executed_tools && agentMessage.executed_tools.length > 0) {
                        console.log("Executed Tools found:", agentMessage.executed_tools); // ë””ë²„ê¹…
                        // Groq Compound ëª¨ë¸ì˜ ê²€ìƒ‰ ë„êµ¬ ê°ì§€
                        toolOutput = agentMessage.executed_tools.map(tool => {
                            if (tool.type === 'search' || tool.type === 'visit' || tool.name === 'web_search') {
                                return `<div class="ai-tool-call"><strong>ğŸ” ì›¹ ê²€ìƒ‰ ì™„ë£Œ</strong><br>ê²€ìƒ‰ ê²°ê³¼ë¥¼ ë°”íƒ•ìœ¼ë¡œ ë‹µë³€ì„ ìƒì„±í–ˆìŠµë‹ˆë‹¤.<br></div>`;
                            }
                            return formatExecutedTool(tool);
                        }).join(''); 
                    } else if (agentMessage.tool_calls && agentMessage.tool_calls.length > 0) {
                        // tool_callsê°€ ìˆì„ ê²½ìš° (ë‹¤ë¥¸ API ì‘ë‹µ í˜•ì‹)
                        console.log("Tool Calls found (alternative format):", agentMessage.tool_calls);
                        // ë‹¨ìˆœíˆ ì‘ë‹µ í”Œë˜ê·¸ë§Œ ì„¤ì •
                        toolOutput = 'tool_calls_detected';
                    }
                    
                    console.log("Agent Response text:", agentResponse); // ë””ë²„ê¹…: ì‘ë‹µ í…ìŠ¤íŠ¸
                    console.log("Tool Output:", toolOutput); // ë””ë²„ê¹…: ë„êµ¬ ì¶œë ¥
                    
                    // í•­ìƒ chatHistoryì— ì¶”ê°€ (ë¹ˆ ì‘ë‹µë„ í¬í•¨)
                    chatHistory.push(agentMessage);
                    
                    if (toolOutput === 'tool_calls_detected' || (toolOutput && !agentResponse)) {
                        // tool_callsê°€ ê°ì§€ë˜ì—ˆìœ¼ë‚˜ ì‘ë‹µì´ ì—†ê±°ë‚˜, executed_toolsê°€ ìˆìœ¼ë‚˜ ì‘ë‹µì´ ì—†ëŠ” ê²½ìš°
                        // ë‹¨ìˆœí•˜ê²Œ ì‚¬ìš©ìì˜ ì›ë˜ ì§ˆë¬¸ë§Œ ë‹¤ì‹œ ë˜ì§
                        loadingMessage.innerHTML = formatAgentResponse("ì •ë³´ë¥¼ ì°¾ê³  ìˆìŠµë‹ˆë‹¤...");
                        
                        // chatHistoryì—ì„œ ë§ˆì§€ë§‰ ë¹ˆ ì‘ë‹µ ì œê±°
                        if (chatHistory.length > 0) {
                            chatHistory.pop();
                        }
                        
                        // ì‹ ì„ í•œ ìš”ì²­ìœ¼ë¡œ ì¬ì‹œë„ - ë„êµ¬ ì‚¬ìš© ì•ˆ í•¨ (ì§ì ‘ ë‹µë³€)
                        const freshMessages = [
                            { role: "system", content: "You are Assistant GPT. Answer the user's question directly and concisely in Korean. Do NOT mention tools or searches. Just provide the answer." },
                            { role: "user", content: userGoal }
                        ];
                        
                        const freshPayload = {
                            model: selectedModel,
                            messages: freshMessages,
                            temperature: 0.7,
                            max_tokens: 4096
                            // toolsì™€ tool_choice ì œê±° - ì§ì ‘ í…ìŠ¤íŠ¸ ì‘ë‹µë§Œ ë°›ìŒ
                        };
                        
                        const freshOptions = {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${GROQ_API_KEY}`
                            },
                            body: JSON.stringify(freshPayload)
                        };
                        
                        try {
                            const freshResponse = await fetchWithRetry('https://api.groq.com/openai/v1/chat/completions', freshOptions);
                            const freshData = await freshResponse.json();
                            
                            console.log("Fresh retry response:", freshData);
                            
                            if (freshData.choices && freshData.choices.length > 0) {
                                const freshChoice = freshData.choices[0];
                                const freshMessage = freshChoice.message;
                                const freshResponse_text = freshMessage.content || '';
                                
                                console.log("Fresh response text:", freshResponse_text);
                                
                                if (freshResponse_text.trim()) {
                                    chatHistory.push({ role: "user", content: userGoal });
                                    chatHistory.push(freshMessage);
                                    loadingMessage.innerHTML = formatAgentResponse(freshResponse_text);
                                } else {
                                    // ë¹ˆ ì‘ë‹µì´ ì˜¨ ê²½ìš° - ì¶”ê°€ ë¡œê¹…
                                    console.warn("Fresh response was empty. Full message:", freshMessage);
                                    loadingMessage.innerHTML = formatAgentResponse("ë‹µë³€ì„ ìƒì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. API ìƒíƒœë¥¼ í™•ì¸í•´ ì£¼ì„¸ìš”.");
                                }
                            } else {
                                console.error("No choices in fresh response:", freshData);
                                loadingMessage.innerHTML = formatAgentResponse("API ì‘ë‹µ ì˜¤ë¥˜ì…ë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.");
                            }
                        } catch (error) {
                            console.error("Fresh retry error:", error);
                            loadingMessage.innerHTML = formatAgentResponse("ì¬ìš”ì²­ ì¤‘ ì˜¤ë¥˜: " + error.message);
                        }
                    } else if (toolOutput && agentResponse) {
                        // ëª¨ë¸ì´ ì´ë¯¸ ì‘ë‹µì„ ìƒì„±í•œ ê²½ìš°
                        loadingMessage.innerHTML = toolOutput + formatAgentResponse(agentResponse);
                    } else if (agentResponse) {
                        // íˆ´ ì—†ì´ ì§ì ‘ ì‘ë‹µ
                        loadingMessage.innerHTML = formatAgentResponse(agentResponse);
                    } else {
                        // ì™„ì „íˆ ë¹ˆ ì‘ë‹µ (ì´ìƒ ìƒí™©)
                        loadingMessage.innerHTML = formatAgentResponse("ì‘ë‹µì„ ë°›ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.");
                    }


                } else {
                    const errorMessage = data.error?.message || "Unknown error occurred.";
                    loadingMessage.innerHTML = formatAgentResponse(`**API ì‘ë‹µ ì˜¤ë¥˜:** ${errorMessage}<br>ì„¤ì •ì—ì„œ API í‚¤ì™€ ëª¨ë¸ì„ í™•ì¸í•´ ì£¼ì„¸ìš”.`);
                    console.error("API response failure:", data);
                }

            } catch (error) {
                console.error("Fetch error:", error);
                loadingMessage.innerHTML = formatAgentResponse(`**ì—°ê²° ì˜¤ë¥˜:** Groq APIì— ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë„¤íŠ¸ì›Œí¬ ë˜ëŠ” API í‚¤ë¥¼ í™•ì¸í•´ ì£¼ì„¸ìš”. ìƒì„¸: ${error.message}`);
            }
        }
        
        // --- Event Listeners ---

        settingsBtn.addEventListener('click', () => {
            // Load current values before opening modal
            apiKeyInput.value = GROQ_API_KEY || '';
            modelSelect.value = modelSelect.value || 'openai/gpt-oss-20b'; 
            browserSearchToggle.checked = isBrowserSearchEnabled;
            pythonServerToggle.checked = usePythonServer;
            settingsModal.style.display = 'flex';
        });

        closeModalBtn.addEventListener('click', () => {
            const key = apiKeyInput.value.trim();
            const model = modelSelect.value;
            const searchEnabled = browserSearchToggle.checked;
            const pythonEnabled = pythonServerToggle.checked;
            isBrowserSearchEnabled = searchEnabled;
            usePythonServer = pythonEnabled;
            
            if (key) {
                GROQ_API_KEY = key;
                saveSettings(key, model, isBrowserSearchEnabled, usePythonServer);
                console.log("ëª¨ë“  ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤. Python Server:", usePythonServer);
            } else {
                GROQ_API_KEY = null;
                saveSettings('', model, isBrowserSearchEnabled, usePythonServer);
                console.log("API í‚¤ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.");
            }
            settingsModal.style.display = 'none';
            updateUIState();
        });

        promptInput.addEventListener('input', () => {
            autoResizeTextarea();
            updateUIState();
        });
        
        // Listen for model change inside modal to update status immediately
        modelSelect.addEventListener('change', () => {
            if (GROQ_API_KEY) {
                 saveSettings(GROQ_API_KEY, modelSelect.value, isBrowserSearchEnabled);
            }
            updateUIState(); // Update status text when model changes
        });

        promptInput.addEventListener('keydown', (event) => {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault(); // Prevent new line
                if (!submitBtn.disabled) {
                    processGoal();
                }
            }
        });

        submitBtn.addEventListener('click', processGoal);

        // Initial setup on load
        window.onload = () => {
            loadSettings(); // Load persisted settings
            // Python í† ê¸€ ìƒíƒœ ì´ˆê¸°í™”
            console.log("ì´ˆê¸°í™” - usePythonServer:", usePythonServer);
            if (pythonServerToggle) {
                pythonServerToggle.checked = usePythonServer;
                console.log("í† ê¸€ ì²´í¬ ì„¤ì •ë¨:", pythonServerToggle.checked);
            }
            updateUIState();
        };

    </script>
</body>
</html>
